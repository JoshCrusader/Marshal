SELECT U.FNAME, U.LNAME 
FROM USERS U 	JOIN HOMEOWNER HO 
				  ON U.USERID = HO.USERID
				JOIN REF_PROPERTIES RP
                  ON HO.BLOCKNUM = RP.BLOCKNUM 
				 AND HO.LOTNUM = RP.LOTNUM
GROUP BY 1, 2;

select userid from homeowner;
select * from homeowner;

SELECT B.* 
FROM BILLING B JOIN REF_PROPERTIES RP
                  ON B.BLOCKNUM = RP.BLOCKNUM 
				 AND B.LOTNUM = RP.LOTNUM
			   JOIN HOMEOWNER HO
                 ON RP.BLOCKNUM = HO.BLOCKNUM
                 AND RP.LOTNUM = HO.LOTNUM
WHERE HO.USERID = "1";

SELECT B.* FROM BILLING B JOIN REF_PROPERTIES RP ON B.BLOCKNUM = RP.BLOCKNUM AND B.LOTNUM = RP.LOTNUM JOIN HOMEOWNER HO ON RP.BLOCKNUM = HO.BLOCKNUM AND RP.LOTNUM = HO.LOTNUM WHERE HO.USERID = '1';
SELECT B.BILLDATE, B.TOTALDUE, B.TOTALPAID FROM BILLING B JOIN REF_PROPERTIES RP ON B.BLOCKNUM = RP.BLOCKNUM AND B.LOTNUM = RP.LOTNUM WHERE B.BLOCKNUM = '1' AND B.LOTNUM = '1';
SELECT B.* FROM BILLING B JOIN REF_PROPERTIES RP ON B.BLOCKNUM = RP.BLOCKNUM AND B.LOTNUM = RP.LOTNUM WHERE B.BLOCKNUM = '1' AND B.LOTNUM = '1';
        
SELECT RP.BLOCKNUM, RP.LOTNUM, RP.STREET
FROM REF_PROPERTIES	RP 	JOIN HOMEOWNER HO
						  ON RP.BLOCKNUM = HO.BLOCKNUM
						 AND RP.LOTNUM = HO.LOTNUM
						JOIN USERS U
                          ON HO.USERID = U.USERID
WHERE U.FNAME = 'NIGEL' AND U.LNAME = 'TAN';

-- get MOSTRECENT bill
SELECT B.BILLDATE FROM BILLING B WHERE BLOCKNUM = '2' AND LOTNUM = '2' ORDER BY 1 DESC LIMIT 1;
SELECT B.BILLINGID FROM BILLING B WHERE BLOCKNUM = '1' AND LOTNUM = '1' ORDER BY 1 DESC LIMIT 1;

-- registration
select tf.trxid, tf.amount from trxreferences tf 
join users u on tf.trxid = u.trxid 
join homeowner ho on u.userid = ho.userid 
where ho.blocknum = '2' and ho.lotnum = '2' and tf.date > (SELECT B.BILLDATE FROM BILLING B WHERE BLOCKNUM = '2' AND LOTNUM = '2' ORDER BY 1 DESC LIMIT 1);

-- registration2
SELECT U.TRXID, TR.TOTALAMOUNT
FROM HOMEOWNER HO 
JOIN USERS U ON HO.USERID = U.USERID 
JOIN TRXREFERENCES TR ON U.TRXID = TR.TRXID
WHERE HO.BLOCKNUM = '3' AND HO.LOTNUM = '3' AND U.MOVINGIN > (SELECT B.BILLDATE FROM BILLING B WHERE BLOCKNUM = '3' AND LOTNUM = '3' ORDER BY 1 DESC LIMIT 1);

-- monthly dues
select tf.trxid, tf.amount 
from trxreferences tf 
join housemonthlydues hmd on tf.trxID = hmd.trxID 
WHERE HMD.BLOCKNUM = '2' AND HMD.LOTNUM = '2' AND TF.DATE > (SELECT B.BILLDATE FROM BILLING B WHERE BLOCKNUM = '2' AND LOTNUM = '2' ORDER BY 1 DESC LIMIT 1);

-- monthly dues2
SELECT HMD.TRXID, TR.TOTALAMOUNT
FROM HOUSEMONTHLYDUES HMD
JOIN MONTHLYDUES MD ON HMD.MDID = MD.MDID
JOIN TRXREFERENCES TR ON HMD.TRXID = TR.TRXID
WHERE HMD.BLOCKNUM = '3' AND HMD.LOTNUM = '3' AND CONCAT(MD.YEAR, '-', MD.MONTH, '-01') > (SELECT B.BILLDATE FROM BILLING B WHERE BLOCKNUM = '3' AND LOTNUM = '3' ORDER BY 1 DESC LIMIT 1);

-- vehicle
select tf.trxid, tf.amount 
from trxreferences tf 
join USER_VEHICLES UV ON TF.TRXID = UV.trxID 
join users u on uv.userid = u.userid 
join homeowner ho on u.userid = ho.userid
WHERE ho.blocknum = '1' and ho.lotnum = '1' AND tf.date > (SELECT B.BILLDATE FROM BILLING B WHERE BLOCKNUM = '1' AND LOTNUM = '1' ORDER BY 1 DESC LIMIT 1);

-- VEHICLE2
SELECT UV.TRXID, SI.DATERELEASED, TR.TOTALAMOUNT
FROM HOMEOWNER HO 
JOIN USERS U ON HO.USERID = U.USERID 
JOIN USER_VEHICLES UV ON U.USERID = UV.USERID
JOIN STICKERINVENTORY SI ON UV.STICKERID = SI.STICKERID
JOIN TRXREFERENCES TR ON UV.TRXID = TR.TRXID
WHERE HO.BLOCKNUM = '2' AND HO.LOTNUM = '2' AND SI.DATERELEASED > (SELECT B.BILLDATE FROM BILLING B WHERE BLOCKNUM = '2' AND LOTNUM = '2' ORDER BY 1 DESC LIMIT 1);

-- VIOLATIONS
-- user2user
select tf.trxid, tf.amount from trxreferences tf 
join security_violations SV ON TF.TRXID = SV.trxID JOIN USER2USER U2U ON SV.securityReportID = U2U.securityReportID 
join users u on u2u.accused_userid = u.userID join homeowner ho on u.userid = ho.userid 
where ho.blocknum = '1' and ho.lotnum = '1' AND tf.date > (SELECT B.BILLDATE FROM BILLING B WHERE B.BLOCKNUM = '1' AND B.LOTNUM = '1' ORDER BY 1 DESC LIMIT 1);

-- USER2USER 2
SELECT SV.TRXID, TR.TOTALAMOUNT
FROM SECURITY_VIOLATIONS SV
JOIN USER2USER U2U ON SV.securityReportID = U2U.securityReportID 
join users u on u2u.accused_userid = u.userID join homeowner ho on u.userid = ho.userid 
JOIN TRXREFERENCES TR ON TR.TRXID = SV.TRXID
where ho.blocknum = '2' and ho.lotnum = '2' AND SV.REPORTDATE > (SELECT B.BILLDATE FROM BILLING B WHERE B.BLOCKNUM = '2' AND B.LOTNUM = '2' ORDER BY 1 DESC LIMIT 1);

-- user2anyone
select tf.trxid, tf.amount from trxreferences tf 
join security_violations SV ON TF.TRXID = SV.trxID JOIN USER2ANYONE U2A ON SV.securityReportID = U2A.securityReportID 
join users u on u2a.userid = u.userID join homeowner ho on u.userid = ho.userid  
where ho.blocknum = '1' and ho.lotnum = '1' AND tf.date > (SELECT B.BILLDATE FROM BILLING B WHERE B.BLOCKNUM = '1' AND B.LOTNUM = '1' ORDER BY 1 DESC LIMIT 1);

-- USER2anyone 2
SELECT SV.TRXID, TR.TOTALAMOUNT
FROM SECURITY_VIOLATIONS SV
JOIN USER2ANYONE U2A ON SV.securityReportID = U2A.securityReportID 
join users u on u2A.userid = u.userID join homeowner ho on u.userid = ho.userid 
JOIN TRXREFERENCES TR ON TR.TRXID = SV.TRXID
where ho.blocknum = '2' and ho.lotnum = '2' AND SV.REPORTDATE > (SELECT B.BILLDATE FROM BILLING B WHERE B.BLOCKNUM = '2' AND B.LOTNUM = '2' ORDER BY 1 DESC LIMIT 1);


SELECT TOTALPAID FROM BILLING WHERE BILLINGID = '1';

SELECT B.BILLDATE, B.TOTALDUE, B.TOTALPAID FROM BILLING B JOIN REF_PROPERTIES RP ON B.BLOCKNUM = RP.BLOCKNUM AND B.LOTNUM = RP.LOTNUM WHERE B.BLOCKNUM = 1 AND B.LOTNUM = 1;
SELECT B.BILLDATE, B.TOTALDUE, B.TOTALPAID FROM BILLING B JOIN REF_PROPERTIES RP ON B.BLOCKNUM = RP.BLOCKNUM AND B.LOTNUM = RP.LOTNUM WHERE B.BLOCKNUM = '1' AND B.LOTNUM = '1';

INSERT INTO REF_MAPPOINTCATEGORY (MAPPOINTCATEGORYID) VALUES ('1');
INSERT INTO REF_MAPPOINTCATEGORY (MAPPOINTCATEGORYID) VALUES ('2');
INSERT INTO REF_MAPPOINTCATEGORY (MAPPOINTCATEGORYID) VALUES ('3');

INSERT INTO MAPPOINT (MAPPOINTID, MAPPOINTCATEGORYID) VALUES ('12345678', '1');
INSERT INTO MAPPOINT (MAPPOINTID, MAPPOINTCATEGORYID) VALUES ('23456789', '2');
INSERT INTO MAPPOINT (MAPPOINTID, MAPPOINTCATEGORYID) VALUES ('34567891', '3');

INSERT INTO REF_STREET (STREET) VALUES ('Taft');
INSERT INTO REF_STREET (STREET) VALUES ('Buendia');
INSERT INTO REF_STREET (STREET) VALUES ('Vito Cruz');
INSERT INTO REF_STREET (STREET) VALUES ('Recto');

INSERT INTO REF_PROPERTIES (BLOCKNUM, LOTNUM, STREET, MAPPOINTID) VALUES ('1', '1', 'Taft', '1');
INSERT INTO REF_PROPERTIES (BLOCKNUM, LOTNUM, STREET, MAPPOINTID) VALUES ('2', '2', 'Recto', '2');
INSERT INTO REF_PROPERTIES (BLOCKNUM, LOTNUM, STREET, MAPPOINTID) VALUES ('3', '3', 'Buendia', '3');

INSERT INTO USERS (USERID, FNAME, LNAME, TRXID) VALUES ('11526564', 'Nigel', 'Tan', '1');
INSERT INTO USERS (USERID, FNAME, LNAME) VALUES ('11526565', 'Carlos', 'Garcia');
INSERT INTO USERS (USERID, FNAME, LNAME) VALUES ('11526566', 'Yuta', 'Inoue');

INSERT INTO HOMEOWNER (BLOCKNUM, LOTNUM, USERID) VALUES ('1', '1', '11526564');
INSERT INTO HOMEOWNER (BLOCKNUM, LOTNUM, USERID) VALUES ('2', '2', '11526565');
INSERT INTO HOMEOWNER (BLOCKNUM, LOTNUM, USERID) VALUES ('3', '3', '11526566');

INSERT INTO BILLING VALUES ('1', '1', '1', NULL, 500, 200, '2017-11-24', '2017-11-30');
INSERT INTO BILLING VALUES ('2', '1', '1', '1', 1000, 800, '2017-11-24', '2017-11-30');
INSERT INTO BILLING VALUES ('3', '2', '2', NULL,900, 0, '2017-11-25', '2017-11-30');
INSERT INTO BILLING VALUES ('4', '3', '3', NULL,800, 400, '2017-11-25', '2017-11-30');
INSERT INTO BILLING VALUES ('5', '1', '1', '2', 700, 0, '2017-11-25', '2017-11-30');

INSERT INTO TRXREFERENCES (TRXID, AMOUNT, INTEREST, TOTALAMOUNT, DESCRIPTION) VALUES ('1', 100, 0, 100, 'Registration');
INSERT INTO TRXREFERENCES (TRXID, AMOUNT, INTEREST, TOTALAMOUNT, DESCRIPTION) VALUES ('2', 200, 0, 200, 'Vehicle');
INSERT INTO TRXREFERENCES (TRXID, AMOUNT, INTEREST, TOTALAMOUNT, DESCRIPTION) VALUES ('3', 200, 0, 200, 'Violation');
INSERT INTO TRXREFERENCES (TRXID, AMOUNT, INTEREST, TOTALAMOUNT, DESCRIPTION) VALUES ('4', 300, 0, 300, 'Violation');
INSERT INTO TRXREFERENCES (TRXID, AMOUNT, INTEREST, TOTALAMOUNT, DESCRIPTION) VALUES ('5', 200, 0, 200, 'Registration');
INSERT INTO TRXREFERENCES (TRXID, AMOUNT, INTEREST, TOTALAMOUNT, DESCRIPTION) VALUES ('6', 200, 0, 200, 'Violation');
INSERT INTO TRXREFERENCES (TRXID, AMOUNT, INTEREST, TOTALAMOUNT, DESCRIPTION) VALUES ('7', 100, 0, 100, 'Violation');
INSERT INTO TRXREFERENCES (TRXID, AMOUNT, INTEREST, TOTALAMOUNT, DESCRIPTION) VALUES ('8', 200, 0, 200, 'Violation');
INSERT INTO TRXREFERENCES (TRXID, AMOUNT, INTEREST, TOTALAMOUNT, DESCRIPTION) VALUES ('9', 300, 0, 300, 'Violation');
INSERT INTO TRXREFERENCES (TRXID, AMOUNT, INTEREST, TOTALAMOUNT, DESCRIPTION) VALUES ('10', 300, 0, 300, 'Monthly Dues');
INSERT INTO TRXREFERENCES (TRXID, AMOUNT, INTEREST, TOTALAMOUNT, DESCRIPTION) VALUES ('11', 50, 0, 50, 'Monthly Dues');

INSERT INTO TRANSACTION_JOURNAL (JOURNALID) VALUES ('1');
INSERT INTO TRANSACTION_JOURNAL (JOURNALID) VALUES ('2');
INSERT INTO TRANSACTION_JOURNAL (JOURNALID) VALUES ('3');

INSERT INTO TRXLIST VALUES ('1', '1', 100);
INSERT INTO TRXLIST VALUES ('1', '2', 200);
INSERT INTO TRXLIST VALUES ('1', '3', 200);
INSERT INTO TRXLIST VALUES ('1', '4', 300);
INSERT INTO TRXLIST VALUES ('2', '5', 200);
INSERT INTO TRXLIST VALUES ('2', '6', 200);
INSERT INTO TRXLIST VALUES ('3', '7', 100);
INSERT INTO TRXLIST VALUES ('3', '8', 200);
INSERT INTO TRXLIST VALUES ('3', '9', 300);
INSERT INTO TRXLIST VALUES ('3', '10', 300);

INSERT INTO BILLINGDETAILS VALUES ('1', '1');
INSERT INTO BILLINGDETAILS VALUES ('1', '2');
INSERT INTO BILLINGDETAILS VALUES ('1', '3');
INSERT INTO BILLINGDETAILS VALUES ('1', '4');
INSERT INTO BILLINGDETAILS VALUES ('3', '5');
INSERT INTO BILLINGDETAILS VALUES ('3', '6');
INSERT INTO BILLINGDETAILS VALUES ('4', '7');
INSERT INTO BILLINGDETAILS VALUES ('4', '8');
INSERT INTO BILLINGDETAILS VALUES ('4', '9');
INSERT INTO BILLINGDETAILS VALUES ('4', '10');

INSERT INTO REF_MONTHLYDUES VALUES ('1', '2016', '12', '2016', 50);
INSERT INTO MONTHLYDUES VALUES ('1', '2016', 50, '1');
INSERT INTO HOUSEMONTHLYDUES VALUES ('1', '1', '1', '11');

INSERT INTO USER_VEHICLES (PLATENUM, USERID, TRXID) VALUES ('PMO531', '11526564', '2');

INSERT INTO SECURITY_VIOLATIONS (SECURITYREPORTID, TRXID, MAPPOINTID) VALUES ('1', '3', '12345678');
INSERT INTO SECURITY_VIOLATIONS (SECURITYREPORTID, TRXID, MAPPOINTID) VALUES ('2', '4', '12345678');

INSERT INTO USER2USER VALUES ('1', '11526565', '11526564');
INSERT INTO USER2ANYONE VALUES ('2', '11526564', 'Josh group');

CREATE EVENT UPDATETOTALDUES
	ON SCHEDULE
       EVERY 1 DAY
	STARTS DATE(NOW())
    DO
    UPDATE BILLING SET TOTALDUE = TOTALDUE + (TOTALDUE * 0.02) WHERE DATE(NOW()) > BILLDUE;
    

SELECT * FROM BILLING WHERE DATE(NOW()) > BILLDUE;
UPDATE BILLING SET TOTALDUE = TOTALDUE + (TOTALDUE * 0.02) WHERE DATE(NOW()) > BILLDUE;